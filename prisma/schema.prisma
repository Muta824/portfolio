generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  //url      = env("ACCELERATE_DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  emailVerified DateTime? @map("email_verified")
  image         String?
  updatedAt     DateTime  @updatedAt
  role          String?   @default("user")
  login         String?   @unique
  password      String?
  posts         Post[]
  todos         Todo[]
  accounts      Account[]
  sessions      Session[]
  answerSets    AnswerSet[]
  userAnswerSheets UserAnswerSheet[]
  results       Result[]

  @@map("users")
}

model Account {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_providerAccountId")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Post {
  id           String     @id @default(cuid())
  title        String
  content      String
  authorId     String
  publishedAt  DateTime   @default(now())
  slug         String     @unique
  updatedAt    DateTime   @updatedAt
  thumbnailUrl String?
  categoryId   String[]
  comments     Comment[]
  author       User       @relation(fields: [authorId], references: [id])
  categories   Category[] @relation("PostToCategory")
  tags         Tag[]      @relation("PostToTag")
}

model Category {
  id    String @id @default(cuid())
  name  String @unique
  posts Post[] @relation("PostToCategory")
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  posts Post[] @relation("PostToTag")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  author    String
  email     String
  createdAt DateTime @default(now())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
}

model Todo {
  id         String    @id @default(cuid())
  title      String
  completed  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  userId     String?
  type       String    @default("daily")
  weekStart  DateTime?
  monthStart DateTime?
  yearStart  DateTime?
  user       User?     @relation(fields: [userId], references: [id])
}

// models for TOEIC scoring app
model TestSet {
  id        String   @id @default(cuid())
  name      String   // user can define the name of each test set (e.g. "公式TOEIC Listening & Reading 問題集11")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions      Question[]
  answerSets     AnswerSet[]
  userAnswerSheets UserAnswerSheet[]
  results        Result[]

  @@map("test_sets")
}

model Question {
  id        String   @id @default(cuid())
  testSetId String   @map("test_set_id")
  qId       Int      // question number (1-200)
  part      Int      // part number (1-7)
  choices   String[] // choices ["A", "B", "C", "D"]

  testSet   TestSet  @relation(fields: [testSetId], references: [id], onDelete: Cascade)

  @@unique([testSetId, qId])
  @@map("questions")
}

model AnswerSet {
  id        String   @id @default(cuid())
  testSetId String   @map("test_set_id")
  name      String   // name of the answer set (e.g. "模範解答")
  userId    String   @map("user_id")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers   Answer[] // correct answers of each question

  testSet   TestSet  @relation(fields: [testSetId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("answer_sets")
}

model Answer {
  id          String    @id @default(cuid())
  answerSetId String    @map("answer_set_id")
  questionId  Int       // question number (qId)
  correctAnswer String  // correct answer (e.g. "A", "B", "C", "D")

  answerSet   AnswerSet @relation(fields: [answerSetId], references: [id], onDelete: Cascade)

  @@unique([answerSetId, questionId])
  @@map("answers")
}

model UserAnswerSheet {
  id        String   @id @default(cuid())
  testSetId String   @map("test_set_id")
  name      String   // user can define the name of each answer sheet (e.g. "1回目", "2回目")
  userId    String   @map("user_id")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userAnswers UserAnswer[] // user's answers
  result       Result?

  testSet      TestSet @relation(fields: [testSetId], references: [id], onDelete: Cascade)
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_answer_sheets")
}

model UserAnswer {
  id              String          @id @default(cuid())
  answerSheetId   String          @map("answer_sheet_id")
  questionId      Int             // question number (qId)
  userAnswer      String?         // user's answer (e.g. "A", "B", "C", "D" or null)

  answerSheet     UserAnswerSheet @relation(fields: [answerSheetId], references: [id], onDelete: Cascade)

  @@unique([answerSheetId, questionId])
  @@map("user_answers")
}

model Result {
  id            String          @id @default(cuid())
  answerSheetId String          @unique @map("answer_sheet_id")
  testSetId     String          @map("test_set_id")
  name          String          // name of the result (related to AnswerSheet's name)
  userId        String          @map("user_id")
  score         Int             // TOEIC score (990 points满分)
  percentage    Float           // accuracy rate (0-100)
  correctCount  Int             // number of correct answers
  totalQuestions Int            @default(200) @map("total_questions")
  completedAt   DateTime        @default(now()) @map("completed_at")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  answerSheet   UserAnswerSheet @relation(fields: [answerSheetId], references: [id], onDelete: Cascade)
  testSet       TestSet         @relation(fields: [testSetId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("results")
}
